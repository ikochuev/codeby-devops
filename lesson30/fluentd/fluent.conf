<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

<filter service.post>
  @type parser
  format json
  key_name log
</filter>

<filter service.ui>
  @type parser
  key_name log
  <parse>
    @type regexp
    expression /^I,\s+\[(?<time>[^\]]+)\]\s+(?<level>\S+)\s+--\s+:\s+service=(?<service>\S+)\s+\|\s+event=(?<event>\S+)(?:\s+\|\s+path=(?<path>[^|]+))?\s+\|\s+request_id=(?<request_id>[^ ]+)(?:\s+\|\s+remote_addr=(?<remote_addr>[^ ]+))?(?:\s+\|\s+method=\s*(?<method>\S+))?(?:\s+\|\s+response_status=(?<response_status>\d+))?\s+\|\s+message='(?<message>[^']+)'\s+\|\s+params:\s*(?<params>.*)$/
  </parse>
</filter>

<filter service.ui>
  @type parser
  key_name log
  reserve_data true
  emit_invalid_record_to_error false
  <parse>
    @type grok
    grok_name_key parsed_by
    grok_failure_key grok_failure
    grok_pattern I,\s+\[%{TIMESTAMP_ISO8601:time}\s+#%{INT:pid}\]\s+%{LOGLEVEL:level}\s+--\s+:\s+service=%{WORD:service}\s+\|\s+event=%{WORD:event}\s+\|\s+request_id=%{UUID:request_id}\s+\|\s+message='%{DATA:message}'\s+\|\s+params:\s+%{GREEDYDATA:params}
  </parse>
</filter>

<match *.**>
  @type copy
  <store>
    @type elasticsearch
    host elasticsearch
    port 9200
    logstash_format true
    suppress_type_name true
    logstash_prefix fluentd
    logstash_dateformat %Y%m%d
    include_tag_key true
    type_name access_log
    tag_key @log_name
    flush_interval 1s
  </store>
  <store>
    @type stdout
  </store>
</match>
